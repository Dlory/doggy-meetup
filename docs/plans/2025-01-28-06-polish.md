# é˜¶æ®µå…­ï¼šå®Œå–„ä¸ä¼˜åŒ– Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** æ¨é€é€šçŸ¥ã€åœ°ç‚¹ç®¡ç†ã€UI/UX ä¼˜åŒ–ã€Bug ä¿®å¤

**Duration:** 3-5å¤©

**Tech Stack:** Firebase Cloud Messaging, Mapbox Geocoding, React Native

**Reference:** `docs/designs/2025-01-28-doggy-meetup-design.md`

---

## Task 1: æ¨é€é€šçŸ¥æœåŠ¡

**Files:**
- Create: `server/app/services/notification_service.py` - æ¨é€æœåŠ¡
- Create: `server/app/api/v1/notifications.py` - é€šçŸ¥è·¯ç”±
- Modify: `apps/src/services/notifications.ts` - å‰ç«¯é€šçŸ¥æœåŠ¡

**Step 1: åˆ›å»ºåç«¯æ¨é€æœåŠ¡**

```python
# server/app/services/notification_service.py
from firebase_admin import messaging, credentials
from app.core.config import settings

# åˆå§‹åŒ– Firebase
if settings.FIREBASE_CREDENTIALS_PATH:
    cred = credentials.Certificate(settings.FIREBASE_CREDENTIALS_PATH)
    messaging.initialize_app(cred)

class NotificationService:
    async def send_to_user(
        self, user_id: str, title: str, body: str, data: dict | None = None
    ) -> bool:
        """å‘é€æ¨é€é€šçŸ¥ç»™æŒ‡å®šç”¨æˆ·"""
        # è·å–ç”¨æˆ·çš„ FCM token
        # ...

        message = messaging.Message(
            notification=messaging.Notification(title=title, body=body),
            data=data or {},
            token=fcm_token,
        )

        try:
            messaging.send(message)
            return True
        except Exception as e:
            print(f"Failed to send notification: {e}")
            return False

    async def send_to_group(
        self, group_id: str, title: str, body: str, data: dict | None = None
    ):
        """å‘é€æ¨é€é€šçŸ¥ç»™ç¾¤ç»„æˆå‘˜"""
        # è·å–ç¾¤ç»„æˆå‘˜çš„ FCM tokens
        # ...

        message = messaging.MulticastMessage(
            notification=messaging.Notification(title=title, body=body),
            data=data or {},
            tokens=tokens,
        )

        messaging.send_multicast(message)

    async def send_session_reminder(self, session_id: str):
        """å‘é€èšä¼šå¼€å§‹å‰ 15 åˆ†é’Ÿæé†’"""
        # è·å–èšä¼šä¿¡æ¯
        # ...

        await self.send_to_group(
            group_id,
            title="ğŸ”” èšä¼šå³å°†å¼€å§‹",
            body=f"ã€Œ{session.title}ã€å°†åœ¨ 15 åˆ†é’Ÿåå¼€å§‹",
            data={"type": "session_reminder", "session_id": str(session_id)},
        )


notification_service = NotificationService()
```

**Step 2: åˆ›å»ºé€šçŸ¥è·¯ç”±**

```python
# server/app/api/v1/notifications.py
from fastapi import APIRouter, Body

router = APIRouter(prefix="/notifications", tags=["é€šçŸ¥"])

@router.post("/register-token")
async def register_token(user_id: str, token: str):
    """æ³¨å†Œ FCM Token"""
    # ä¿å­˜åˆ°æ•°æ®åº“
    pass

@router.post("/send-test")
async def send_test_notification(user_id: str):
    """å‘é€æµ‹è¯•é€šçŸ¥"""
    from app.services.notification_service import notification_service
    await notification_service.send_to_user(
        user_id, "æµ‹è¯•é€šçŸ¥", "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"
    )
```

**Step 3: åˆ›å»ºå‰ç«¯é€šçŸ¥æœåŠ¡**

```typescript
// apps/src/services/notifications.ts
import messaging from '@react-native-firebase/messaging';
import { platform } from 'react-native';

export const notificationService = {
  async requestPermission() {
    const authStatus = await messaging().requestPermission();
    return (
      authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
      authStatus === messaging.AuthorizationStatus.PROVISIONAL
    );
  },

  async getToken() {
    if (!messaging().isDeviceRegisteredForRemoteMessages) {
      await messaging().registerDeviceForRemoteMessages();
    }
    const token = await messaging().getToken();
    return token;
  },

  async registerToken() {
    const enabled = await this.requestPermission();
    if (enabled) {
      const token = await this.getToken();
      // å‘é€åˆ°åç«¯
      // await api.post('/notifications/register-token', { token });
    }
  },

  onNotification(listener: (notification: any) => void) {
    return messaging().onNotificationOpenedApp(remoteMessage => {
      listener(remoteMessage);
    });
  },

  onBackgroundNotification(listener: (message: any) => void) {
    return messaging().setBackgroundMessageHandler(async message => {
      listener(message);
    });
  },
};
```

**Step 4: æäº¤**

```bash
git add server/app/services/notification_service.py server/app/api/v1/notifications.ts
git commit -m "feat: add push notification service"
```

---

## Task 2: Celery å®šæ—¶ä»»åŠ¡

**Files:**
- Create: `server/app/tasks/celery_app.py` - Celery åº”ç”¨
- Create: `server/app/tasks/notification_tasks.py` - å®šæ—¶ä»»åŠ¡

**Step 1: åˆ›å»º Celery åº”ç”¨**

```python
# server/app/tasks/celery_app.py
from celery import Celery
from app.core.config import settings

celery_app = Celery(
    "doggy_meetup",
    broker=settings.REDIS_URL,
    backend=settings.REDIS_URL,
)

celery_app.conf.update(
    task_routes={
        "app.tasks.notification_tasks.*": {"queue": "notifications"},
    },
    beat_schedule={
        "check-sessions-every-5-minutes": {
            "task": "app.tasks.notification_tasks.check_upcoming_sessions",
            "schedule": 300.0,  # 5 åˆ†é’Ÿ
        },
    },
)
```

**Step 2: åˆ›å»ºå®šæ—¶ä»»åŠ¡**

```python
# server/app/tasks/notification_tasks.py
from app.tasks.celery_app import celery_app
from app.services.notification_service import notification_service
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import AsyncSessionLocal
from datetime import datetime, timedelta

@celery_app.task
def check_upcoming_sessions():
    """æ£€æŸ¥å³å°†å¼€å§‹çš„èšä¼šï¼Œå‘é€æé†’"""
    import asyncio

    async def _check():
        async with AsyncSessionLocal() as db:
            # æŸ¥è¯¢ 15 åˆ†é’Ÿå†…å¼€å§‹çš„èšä¼š
            soon = datetime.utcnow() + timedelta(minutes=15)
            sessions = await db.execute(
                select(Session).where(
                    Session.scheduled_at <= soon,
                    Session.scheduled_at > datetime.utcnow(),
                    Session.status == SessionStatus.upcoming,
                )
            )

            for session in sessions.scalars():
                await notification_service.send_session_reminder(session.id)

    asyncio.run(_check())
```

**Step 3: æäº¤**

```bash
git add server/app/tasks/
git commit -m "feat: add Celery for scheduled tasks"
```

---

## Task 3: åœ°ç‚¹ç®¡ç†åŠŸèƒ½

**Files:**
- Create: `apps/src/screens/location/LocationManageScreen.tsx` - åœ°ç‚¹ç®¡ç†
- Create: `apps/src/screens/location/LocationCreateScreen.tsx` - åˆ›å»ºåœ°ç‚¹
- Create: `server/app/services/mapbox_service.py` - Mapbox Geocoding

**Step 1: åˆ›å»º Mapbox åœ°ç†ç¼–ç æœåŠ¡**

```python
# server/app/services/mapbox_service.py
import httpx
from app.core.config import settings

class MapboxService:
    async def geocode(self, query: str) -> list[dict]:
        """åœ°å€æœç´¢"""
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"https://api.mapbox.com/geocoding/v5/mapbox.places/{query}.json",
                params={"access_token": settings.MAPBOX_ACCESS_TOKEN}
            )
            return response.json().get("features", [])

    async def reverse_geocode(self, longitude: float, latitude: float) -> dict:
        """é€†åœ°ç†ç¼–ç """
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"https://api.mapbox.com/geocoding/v5/mapbox.places/{longitude},{latitude}.json",
                params={"access_token": settings.MAPBOX_ACCESS_TOKEN}
            )
            return response.json()


mapbox_service = MapboxService()
```

**Step 2: åˆ›å»ºåœ°ç‚¹ç®¡ç†é¡µé¢**

```typescript
// apps/src/screens/location/LocationManageScreen.tsx
import React from 'react';
import { View, Text, FlatList, TouchableOpacity, StyleSheet } from 'react-native';

export default function LocationManageScreen({ navigation }: any) {
  const [locations, setLocations] = useState<Location[]>([]);
  const [filter, setFilter] = useState<'all' | 'my' | 'favorite'>('all');

  return (
    <View style={styles.container}>
      <View style={styles.tabs}>
        {['all', 'my', 'favorite'].map((tab) => (
          <TouchableOpacity
            key={tab}
            style={[styles.tab, filter === tab && styles.activeTab]}
            onPress={() => setFilter(tab as any)}
          >
            <Text>{tab === 'all' ? 'å…¨éƒ¨' : tab === 'my' ? 'æˆ‘åˆ›å»ºçš„' : 'æ”¶è—'}</Text>
          </TouchableOpacity>
        ))}
      </View>

      <FlatList
        data={locations}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <TouchableOpacity
            style={styles.locationItem}
            onPress={() => navigation.navigate('LocationDetail', { locationId: item.id })}
          >
            <Text style={styles.name}>{item.name}</Text>
            <Text style={styles.address}>{item.address}</Text>
            {item.is_dog_friendly && <Text style={styles.tag}>ğŸ• é€‚åˆç‹—ç‹—</Text>}
          </TouchableOpacity>
        )}
      />

      <TouchableOpacity
        style={styles.fab}
        onPress={() => navigation.navigate('LocationCreate')}
      >
        <Text style={styles.fabText}>+ æ·»åŠ åœ°ç‚¹</Text>
      </TouchableOpacity>
    </View>
  );
}
```

**Step 3: æäº¤**

```bash
git add apps/src/screens/location/ server/app/services/mapbox_service.py
git commit -m "feat: add location management"
```

---

## Task 4: åŠ¨æ€å¹¿åœºåŠŸèƒ½ï¼ˆåŸºç¡€ç‰ˆï¼‰

**Files:**
- Create: `server/app/schemas/post.py` - åŠ¨æ€ Schema
- Create: `server/app/api/v1/posts.py` - åŠ¨æ€è·¯ç”±
- Create: `apps/src/screens/plaza/PostListScreen.tsx` - åŠ¨æ€åˆ—è¡¨
- Create: `apps/src/screens/plaza/PostDetailScreen.tsx` - åŠ¨æ€è¯¦æƒ…
- Create: `apps/src/screens/plaza/PostCreateScreen.tsx` - å‘å¸ƒåŠ¨æ€

**Step 1: åˆ›å»ºåŠ¨æ€ API**

```python
# server/app/api/v1/posts.py
from fastapi import APIRouter

router = APIRouter(prefix="/posts", tags=["åŠ¨æ€"])

@router.get("", response_model=list[PostResponse])
async def get_posts(limit: int = 20, offset: int = 0):
    """è·å–åŠ¨æ€åˆ—è¡¨"""
    pass

@router.post("", response_model=PostResponse)
async def create_post(data: PostCreate):
    """å‘å¸ƒåŠ¨æ€"""
    pass

@router.get("/{post_id}", response_model=PostResponse)
async def get_post(post_id: UUID):
    """è·å–åŠ¨æ€è¯¦æƒ…"""
    pass

@router.post("/{post_id}/like")
async def like_post(post_id: UUID):
    """ç‚¹èµåŠ¨æ€"""
    pass

@router.post("/{post_id}/comments")
async def add_comment(post_id: UUID, content: str):
    """å‘è¡¨è¯„è®º"""
    pass
```

**Step 2: åˆ›å»ºåŠ¨æ€é¡µé¢**

```typescript
// apps/src/screens/plaza/PostListScreen.tsx
import React from 'react';
import { View, FlatList, StyleSheet } from 'react-native';
import PostCard from '@/components/PostCard';

export default function PostListScreen({ navigation }: any) {
  const [posts, setPosts] = useState<Post[]>([]);

  return (
    <View style={styles.container}>
      <FlatList
        data={posts}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <PostCard
            post={item}
            onPress={() => navigation.navigate('PostDetail', { postId: item.id })}
          />
        )}
      />
    </View>
  );
}
```

**Step 3: æäº¤**

```bash
git add server/app/schemas/post.py server/app/api/v1/posts.py apps/src/screens/plaza/Post*
git commit -m "feat: add post/social feed feature"
```

---

## Task 5: UI/UX ä¼˜åŒ–

**Files:**
- Modify: `apps/src/screens/**/*.tsx` - å…¨å±€æ ·å¼ä¼˜åŒ–
- Create: `apps/src/theme/colors.ts` - é¢œè‰²ä¸»é¢˜
- Create: `apps/src/theme/spacing.ts` - é—´è·è§„èŒƒ
- Create: `apps/src/components/Loading.tsx` - åŠ è½½ç»„ä»¶
- Create: `apps/src/components/Empty.tsx` - ç©ºçŠ¶æ€ç»„ä»¶

**Step 1: åˆ›å»ºä¸»é¢˜æ–‡ä»¶**

```typescript
// apps/src/theme/colors.ts
export const Colors = {
  primary: '#FF6B6B',
  secondary: '#4ECDC4',
  accent: '#FFE66D',
  background: '#F7F7F7',
  surface: '#FFFFFF',
  text: '#2D3436',
  textSecondary: '#636E72',
  border: '#DFE6E9',
  success: '#00B894',
  warning: '#FDCB6E',
  error: '#FF7675',
  info: '#74B9FF',

  // Status colors
  recruiting: '#00B894',
  full: '#636E72',
  upcoming: '#0984E3',
  ended: '#B2BEC3',
};

// apps/src/theme/spacing.ts
export const Spacing = {
  xs: 4,
  sm: 8,
  md: 16,
  lg: 24,
  xl: 32,
  xxl: 48,
};
```

**Step 2: åˆ›å»ºé€šç”¨ç»„ä»¶**

```typescript
// apps/src/components/Loading.tsx
import React from 'react';
import { ActivityIndicator, View, StyleSheet } from 'react-native';
import { Colors } from '@/theme/colors';

export default function Loading({ size = 'large' }: { size?: 'small' | 'large' }) {
  return (
    <View style={styles.container}>
      <ActivityIndicator size={size} color={Colors.primary} />
    </View>
  );
}

// apps/src/components/Empty.tsx
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { Colors } from '@/theme/colors';

interface EmptyProps {
  icon?: string;
  message: string;
  action?: { label: string; onPress: () => void };
}

export default function Empty({ icon = 'ğŸ“­', message, action }: EmptyProps) {
  return (
    <View style={styles.container}>
      <Text style={styles.icon}>{icon}</Text>
      <Text style={styles.message}>{message}</Text>
      {action && <TouchableOpacity style={styles.button} onPress={action.onPress}>
        <Text style={styles.buttonText}>{action.label}</Text>
      </TouchableOpacity>}
    </View>
  );
}
```

**Step 3: æäº¤**

```bash
git add apps/src/theme/ apps/src/components/Loading.tsx apps/src/components/Empty.tsx
git commit -m "feat: add theme system and common components"
```

---

## Task 6: é”™è¯¯å¤„ç†ä¸æ—¥å¿—

**Files:**
- Create: `server/app/middleware/error_handler.py` - é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- Create: `apps/src/utils/errorHandler.ts` - å‰ç«¯é”™è¯¯å¤„ç†
- Modify: `apps/src/services/api.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†

**Step 1: åˆ›å»ºåç«¯é”™è¯¯å¤„ç†**

```python
# server/app/middleware/error_handler.py
from fastapi import Request, status
from fastapi.responses import JSONResponse

class AppException(Exception):
    def __init__(self, message: str, code: int = 400):
        self.message = message
        self.code = code


async def app_exception_handler(request: Request, exc: AppException):
    return JSONResponse(
        status_code=exc.code,
        content={"error": exc.message}
    )
```

**Step 2: åˆ›å»ºå‰ç«¯é”™è¯¯å¤„ç†**

```typescript
// apps/src/utils/errorHandler.ts
import Toast from 'react-native-toast-message';

export const handleApiError = (error: any) => {
  const message = error.response?.data?.error || error.message || 'è¯·æ±‚å¤±è´¥';
  Toast.show({
    type: 'error',
    text1: 'é”™è¯¯',
    text2: message,
  });
};

export const showSuccess = (message: string) => {
  Toast.show({
    type: 'success',
    text1: 'æˆåŠŸ',
    text2: message,
  });
};
```

**Step 3: æäº¤**

```bash
git add server/app/middleware/error_handler.py apps/src/utils/errorHandler.ts
git commit -m "feat: add error handling"
```

---

## Task 7: æ€§èƒ½ä¼˜åŒ–

**Files:**
- Modify: `apps/src/screens/**/*.tsx` - æ·»åŠ åˆ—è¡¨ä¼˜åŒ–
- Create: `apps/src/utils/cache.ts` - ç¼“å­˜å·¥å…·

**Step 1: åˆ—è¡¨æ€§èƒ½ä¼˜åŒ–**

```typescript
// ä½¿ç”¨ memo ä¼˜åŒ–åˆ—è¡¨é¡¹
const MemoSessionCard = React.memo(SessionCard);

// æ·»åŠ  keyExtractor
<FlatList
  data={sessions}
  keyExtractor={(item) => item.id}
  renderItem={({ item }) => <MemoSessionCard session={item} ... />}
  removeClippedSubviews={true}
  maxToRenderPerBatch={10}
  windowSize={5}
/>
```

**Step 2: æ·»åŠ ç¼“å­˜**

```typescript
// apps/src/utils/cache.ts
import AsyncStorage from '@react-native-async-storage/async-storage';

export const cache = {
  get: async (key: string) => {
    const value = await AsyncStorage.getItem(`cache:${key}`);
    return value ? JSON.parse(value) : null;
  },

  set: async (key: string, value: any, ttl?: number) => {
    const data = ttl
      ? { value, expire: Date.now() + ttl * 1000 }
      : { value, expire: null };
    await AsyncStorage.setItem(`cache:${key}`, JSON.stringify(data));
  },

  getOrSet: async (key: string, fetcher: () => Promise<any>, ttl?: number) => {
    const cached = await cache.get(key);
    if (cached && (!cached.expire || cached.expire > Date.now())) {
      return cached.value;
    }
    const value = await fetcher();
    await cache.set(key, value, ttl);
    return value;
  },
};
```

**Step 3: æäº¤**

```bash
git add apps/src/utils/cache.ts
git commit -m "feat: add performance optimizations"
```

---

## å®Œæˆæ£€æŸ¥

**åç«¯æ£€æŸ¥:**
```bash
# Celery worker æµ‹è¯•
celery -A app.tasks.celery_app worker -l info

# å®šæ—¶ä»»åŠ¡æµ‹è¯•
celery -A app.tasks.celery_app beat
```

**å‰ç«¯æ£€æŸ¥:**
- [ ] æ¨é€é€šçŸ¥æ­£å¸¸æ¥æ”¶
- [ ] åœ°ç‚¹åˆ›å»º/ç¼–è¾‘æ­£å¸¸
- [ ] åŠ¨æ€å‘å¸ƒ/å±•ç¤ºæ­£å¸¸
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] åˆ—è¡¨æ»šåŠ¨æµç•…

**é˜¶æ®µå…­éªŒæ”¶æ ‡å‡†:**
- [ ] æ¨é€é€šçŸ¥åŠŸèƒ½å®Œæ•´
- [ ] Celery å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
- [ ] åœ°ç‚¹ç®¡ç†åŠŸèƒ½å®Œæ•´
- [ ] åŠ¨æ€å¹¿åœºåŸºç¡€åŠŸèƒ½å¯ç”¨
- [ ] UI/UX ä¼˜åŒ–å®Œæˆ
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ€§èƒ½ä¼˜åŒ–å®æ–½

---

## æ•´ä½“éªŒæ”¶æ¸…å•

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- [ ] ç‹—ç‹—æ¡£æ¡ˆ CRUD
- [ ] ç‹—ç‹— MBTI æµ‹è¯•
- [ ] å‘èµ·/å‚åŠ èšä¼š
- [ ] èšä¼šåˆ—è¡¨ç­›é€‰
- [ ] ä¸´æ—¶å°ç»„èŠå¤©
- [ ] æ¨é€é€šçŸ¥
- [ ] åŠ¨æ€å¹¿åœºï¼ˆåŸºç¡€ç‰ˆï¼‰
- [ ] åœ°ç‚¹ç®¡ç†

### æŠ€æœ¯è´¨é‡
- [ ] API æ¥å£å®Œå–„
- [ ] WebSocket è¿æ¥ç¨³å®š
- [ ] æ•°æ®åº“è¿ç§»æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

### ç”¨æˆ·ä½“éªŒ
- [ ] é¡µé¢äº¤äº’æµç•…
- [ ] åŠ è½½çŠ¶æ€æ˜ç¡®
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] ç©ºçŠ¶æ€å¼•å¯¼
- [ ] ç½‘ç»œå¼‚å¸¸å¤„ç†

### ä»£ç è´¨é‡
- [ ] TypeScript ç±»å‹å®Œæ•´
- [ ] ç»„ä»¶æ‹†åˆ†åˆç†
- [ ] çŠ¶æ€ç®¡ç†æ¸…æ™°
- [ ] ä»£ç é£æ ¼ç»Ÿä¸€
